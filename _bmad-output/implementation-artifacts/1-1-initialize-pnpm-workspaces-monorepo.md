# Story 1.1: Initialize pnpm Workspaces Monorepo

Status: done

## Story

As a **developer**,
I want a pnpm workspaces monorepo with shared TypeScript config and shared types packages,
so that both the web app and MCP server share conventions and I can run the full stack from a single repo.

## Acceptance Criteria

1. Running `pnpm install` from the monorepo root installs all workspace dependencies without errors
2. `packages/typescript-config` exists with `base.json`, `nextjs.json`, and `node.json` — each extending a shared strict base
3. `packages/types` exists with an `index.ts` exporting `Legislator`, `Bill`, `AppError`, `LookupLegislatorResult`, `SearchBillsResult`, and `AnalyticsEvent` interfaces
4. `pnpm --filter web dev` starts the Next.js dev server without errors
5. `pnpm --filter mcp-server dev` starts the MCP server without errors
6. TypeScript strict mode is enabled across all tsconfigs (`strict: true`, no `any`, no `@ts-ignore`)
7. No barrel files (`index.ts` re-exports) exist in `components/` or `tools/`

## Tasks / Subtasks

- [x] Task 1: Initialize monorepo root (AC: 1)
  - [x] Create `package.json` at repo root (workspace root, no runtime dependencies)
  - [x] Create `pnpm-workspace.yaml` declaring `apps/*` and `packages/*`
  - [x] Create root `.gitignore` (node_modules, .env files, data/on-record.db, .next, dist)

- [x] Task 2: Create `packages/typescript-config` (AC: 2, 6)
  - [x] Create `packages/typescript-config/package.json` with `name: "@on-record/typescript-config"`
  - [x] Create `base.json` — strict TS base config (see Dev Notes for exact settings)
  - [x] Create `nextjs.json` — extends `./base.json`, adds Next.js-specific settings
  - [x] Create `node.json` — extends `./base.json`, adds Node.js-specific settings

- [x] Task 3: Create `packages/types` (AC: 3, 6)
  - [x] Create `packages/types/package.json` with `name: "@on-record/types"`
  - [x] Create `packages/types/index.ts` exporting all 6 required interfaces (see Dev Notes for exact shapes)
  - [x] Confirm: NO default exports, NO barrel re-exports of external types

- [x] Task 4: Initialize `apps/web` — Next.js 16.1.6 (AC: 4, 7)
  - [x] Scaffold with `create-next-app@latest` using TypeScript, Tailwind, App Router, src-dir, turbopack flags
  - [x] Update `apps/web/tsconfig.json` to extend `@on-record/typescript-config/nextjs.json`
  - [x] Add `@on-record/typescript-config` and `@on-record/types` as workspace dependencies
  - [x] Initialize shadcn/ui (`npx shadcn@latest init`) — CSS vars written; deps installed via pnpm
  - [x] Create `apps/web/.env.example` (placeholder, no secrets yet)
  - [x] Confirm `apps/web/src/components/ui/` is auto-generated by shadcn — DO NOT create an `index.ts` barrel inside it (AC: 7)
  - [x] Run `pnpm --filter web dev` and confirm no errors

- [x] Task 5: Initialize `apps/mcp-server` — TypeScript skeleton (AC: 5, 6, 7)
  - [x] Create `apps/mcp-server/package.json` with `name: "@on-record/mcp-server"` and `dev` script using `tsx watch src/index.ts`
  - [x] Create `apps/mcp-server/tsconfig.json` extending `@on-record/typescript-config/node.json`
  - [x] Create `apps/mcp-server/.eslintrc.json` with `no-console: ['error', { allow: ['error'] }]` (see Dev Notes)
  - [x] Create `apps/mcp-server/.env.example` with placeholder env var names (content populated in Story 1.2)
  - [x] Create minimal `apps/mcp-server/src/index.ts` placeholder (see Dev Notes — no console.log allowed)
  - [x] Add `@on-record/types` and `@on-record/typescript-config` as workspace dependencies
  - [x] Run `pnpm --filter mcp-server dev` and confirm no errors

- [x] Task 6: Final verification (AC: 1–7)
  - [x] `pnpm install` from repo root completes without errors
  - [x] Both dev servers start cleanly (web: Next.js 16.1.6 on :3000; mcp: tsx watch on :3001)
  - [x] `tsc --noEmit` passes in both apps (zero errors)
  - [x] Confirm no `index.ts` barrel files exist in `components/` or `tools/`

## Dev Notes

### Scope — What Story 1.1 IS and IS NOT

**Story 1.1 scope:**
- Monorepo scaffold (root workspace + pnpm config)
- `packages/typescript-config` — all three tsconfig files
- `packages/types` — all 6 required interfaces
- `apps/web` initialized with Next.js + Tailwind v4 + shadcn/ui
- `apps/mcp-server` minimal skeleton (compiles + starts)

**NOT in Story 1.1 (handled in subsequent stories):**
- Story 1.2: Hono server, rate limiting, pino logging, env validation, CORS, MCP transport
- Story 1.3: SQLite schema initialization
- Story 1.4: `retryWithDelay` utility and `AppError` runtime implementation
- Story 1.5: CI/CD GitHub Actions pipeline and full README

### Monorepo Root Files

**`package.json` (root):**
```json
{
  "name": "on-record",
  "private": true,
  "scripts": {
    "dev:web": "pnpm --filter web dev",
    "dev:mcp": "pnpm --filter mcp-server dev",
    "test": "pnpm --filter mcp-server test",
    "test:e2e": "playwright test"
  },
  "devDependencies": {
    "typescript": "^5.x"
  }
}
```

**`pnpm-workspace.yaml`:**
```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

**`.gitignore` (root — must include):**
```
node_modules/
.env
.env.local
.env.*.local
.next/
dist/
build/
data/on-record.db
*.db-shm
*.db-wal
```

### packages/typescript-config

**`packages/typescript-config/package.json`:**
```json
{
  "name": "@on-record/typescript-config",
  "version": "0.0.1",
  "private": true,
  "exports": {
    "./base.json": "./base.json",
    "./nextjs.json": "./nextjs.json",
    "./node.json": "./node.json"
  }
}
```

**`base.json`:**
```json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "noImplicitOverride": true,
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true,
    "target": "ES2022",
    "lib": ["ES2022"],
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  }
}
```

**`nextjs.json`:**
```json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "extends": "./base.json",
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "ES2017"],
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "jsx": "preserve",
    "allowJs": true,
    "incremental": true,
    "plugins": [{ "name": "next" }],
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

**`node.json`:**
```json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "extends": "./base.json",
  "compilerOptions": {
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "outDir": "./dist"
  }
}
```

### packages/types — Required Interfaces

**`packages/types/package.json`:**
```json
{
  "name": "@on-record/types",
  "version": "0.0.1",
  "private": true,
  "main": "./index.ts",
  "types": "./index.ts"
}
```

**`packages/types/index.ts` — exact interface shapes required:**
```typescript
// Legislator — returned by lookup_legislator MCP tool (FR4, FR5)
export interface Legislator {
  id: string
  chamber: 'house' | 'senate'
  district: number
  name: string
  email: string
  phone: string
  phoneLabel?: string          // API-provided type label (e.g. "cell", "district office")
  phoneTypeUnknown?: boolean   // true when API provides no phone type label (FR5)
  session: string
}

// Bill — returned by search_bills MCP tool (FR6, FR7)
export interface Bill {
  id: string
  session: string
  title: string
  summary: string
  status: string
  sponsorId: string
  voteResult?: string
  voteDate?: string            // ISO 8601 date string: "2024-03-04"
}

// BillDetail — used by LegislatureDataProvider.getBillDetail() (Story 2.2)
// NOTE: Placeholder for now. Full shape finalized in Story 2.2.
export interface BillDetail extends Bill {
  fullText?: string
  subjects?: string[]
}

// AppError — three-field error format used throughout (FR35, FR37)
// NOTE: This is the TYPE CONTRACT. The runtime helper lives in Story 1.4.
export interface AppError {
  source: 'gis-api' | 'legislature-api' | 'cache' | 'mcp-tool' | 'app'
  nature: string    // human-readable description of what failed
  action: string    // what to try next
}

// MCP Tool Response Contracts — field names are part of the public API
// DO NOT change field names without updating the system prompt (Story 4.1)
export interface LookupLegislatorResult {
  legislators: Legislator[]
  session: string
  resolvedAddress: string      // always '[REDACTED]' in logs; actual value in MCP response
}

export interface SearchBillsResult {
  bills: Bill[]
  legislatorId: string
  session: string
}

// AnalyticsEvent — POST /api/events payload (FR39, Story 7.3)
export interface AnalyticsEvent {
  eventType: 'session_initiated' | 'draft_generated' | 'message_delivered'
  districtId?: string
  timestamp: string            // ISO 8601 datetime: "2024-03-04T14:23:00Z"
}
```

**CRITICAL:** No default exports. No re-exports of external library types. Direct named imports only.

### apps/web Initialization

Use **exact command** from architecture.md:
```bash
cd apps/web
npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --turbopack
```

Then initialize shadcn/ui:
```bash
npx shadcn@latest init
```

When shadcn prompts for config: use defaults (New York style, CSS variables, `src/components/ui` path).

Update `apps/web/tsconfig.json` to extend the shared config:
```json
{
  "extends": "@on-record/typescript-config/nextjs.json",
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

Add workspace dependencies to `apps/web/package.json`:
```json
{
  "dependencies": {
    "@on-record/types": "workspace:*"
  },
  "devDependencies": {
    "@on-record/typescript-config": "workspace:*"
  }
}
```

**Tailwind v4 note:** `create-next-app` with `--tailwind` will set up Tailwind. If it defaults to v3, upgrade to v4 and switch to the `@theme` directive in `globals.css`. The full color token system (amber accent, primary navy, etc.) is set up in **Story 2.6** — at this stage, just confirm Tailwind loads without errors.

### apps/mcp-server Initialization

**`apps/mcp-server/package.json`:**
```json
{
  "name": "@on-record/mcp-server",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "test": "vitest run",
    "typecheck": "tsc --noEmit"
  },
  "dependencies": {
    "@on-record/types": "workspace:*"
  },
  "devDependencies": {
    "@on-record/typescript-config": "workspace:*",
    "tsx": "^4.x",
    "typescript": "^5.x",
    "vitest": "^4.0.18"
  }
}
```

**`apps/mcp-server/tsconfig.json`:**
```json
{
  "extends": "@on-record/typescript-config/node.json",
  "compilerOptions": {
    "rootDir": "./src",
    "outDir": "./dist"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

**`apps/mcp-server/.eslintrc.json`:**
```json
{
  "env": {
    "node": true,
    "es2022": true
  },
  "parser": "@typescript-eslint/parser",
  "plugins": ["@typescript-eslint"],
  "rules": {
    "no-console": ["error", { "allow": ["error"] }]
  }
}
```

**`apps/mcp-server/src/index.ts` — minimal placeholder:**
```typescript
// Placeholder MCP server entry point — Story 1.1
// Story 1.2 replaces this with: Hono + StreamableHTTPServerTransport + pino + env validation

const port = process.env.PORT ?? '3001'

// console.log is FORBIDDEN in mcp-server (corrupts JSON-RPC stdout stream)
// console.error is allowed
console.error(`[mcp-server] Starting on port ${port} — placeholder (Story 1.2 will initialize Hono)`)

// Keep process alive for dev watcher
process.stdin.resume()
```

**`apps/mcp-server/.env.example`:**
```
# MCP Server Environment Variables
# Full variable list populated in Story 1.2

PORT=3001
```

### Critical Constraints — DO NOT VIOLATE

1. **No `console.log` in `apps/mcp-server/`** — corrupts the JSON-RPC stdout stream. ESLint enforces this. Use `console.error` only (for Story 1.1 placeholder). Story 1.2 replaces console with pino.

2. **No barrel files** in `components/` or `tools/`:
   - ❌ `apps/web/src/components/index.ts` (exports all components)
   - ❌ `apps/mcp-server/src/tools/index.ts` (re-exports all tools)
   - ✅ Import directly: `import { LegislatorCard } from './components/LegislatorCard'`

3. **No cross-workspace imports**: `apps/web` must not import from `apps/mcp-server` and vice versa. Shared code lives in `packages/types/` only.

4. **TypeScript `strict: true` throughout**: No `any`, no `@ts-ignore`, no `@ts-nocheck`. Use `unknown` and narrow instead.

5. **`packages/types` field names are a public API contract**: `LookupLegislatorResult` and `SearchBillsResult` field names are read by the LLM system prompt (Story 4.1). Do not rename fields without a system prompt update.

6. **Date format**: ISO 8601 strings everywhere (`"2024-03-04"` for dates, `"2024-03-04T14:23:00Z"` for datetimes). Never Unix timestamps in public interfaces.

7. **Null vs undefined**: Use `undefined` for optional/missing values in TypeScript interfaces. `null` only for explicit SQLite NULL results. Interfaces should use `?: string` not `string | null`.

### Project Structure Notes

**Alignment with architecture.md directory structure:**

This story creates the following (partial — final structure completed across all Epic 1 stories):
```
on-record/
├── package.json               ← Task 1
├── pnpm-workspace.yaml        ← Task 1
├── .gitignore                 ← Task 1
├── apps/
│   ├── web/                   ← Task 4 (full Next.js init)
│   │   ├── package.json
│   │   ├── next.config.ts
│   │   ├── tsconfig.json      ← extends @on-record/typescript-config/nextjs.json
│   │   ├── .env.example
│   │   └── src/
│   │       ├── app/
│   │       │   ├── globals.css
│   │       │   ├── layout.tsx
│   │       │   └── page.tsx
│   │       └── components/
│   │           └── ui/        ← shadcn/ui primitives (auto-generated, DO NOT add barrel)
│   └── mcp-server/            ← Task 5 (minimal skeleton)
│       ├── package.json
│       ├── tsconfig.json      ← extends @on-record/typescript-config/node.json
│       ├── .eslintrc.json     ← no-console rule
│       ├── .env.example
│       └── src/
│           └── index.ts       ← placeholder only
└── packages/
    ├── typescript-config/     ← Task 2
    │   ├── package.json
    │   ├── base.json
    │   ├── nextjs.json
    │   └── node.json
    └── types/                 ← Task 3
        ├── package.json
        └── index.ts           ← 6 interfaces
```

**Directories NOT created in Story 1.1** (created in later stories):
- `apps/mcp-server/src/tools/` — Story 2.4, 3.5
- `apps/mcp-server/src/providers/` — Story 2.2
- `apps/mcp-server/src/cache/` — Story 1.3
- `apps/mcp-server/src/middleware/` — Story 1.2
- `apps/mcp-server/src/lib/` — Story 1.4
- `apps/mcp-server/src/routes/` — Story 7.3
- `e2e/` — Story 1.5
- `.github/` — Story 1.5
- `system-prompt/` — Story 4.1

### References

- Architecture: monorepo structure [Source: `_bmad-output/planning-artifacts/architecture.md` → "Starter Template Evaluation"]
- Architecture: complete directory tree [Source: `architecture.md` → "Complete Project Directory Structure"]
- Architecture: TypeScript naming and strict mode rules [Source: `architecture.md` → "Naming Patterns" + "Process Patterns"]
- Architecture: no barrel files rule [Source: `architecture.md` → "Structure Patterns"]
- Architecture: packages/types interface contracts [Source: `architecture.md` → "Format Patterns" → "MCP Tool Response Type Contracts"]
- Architecture: no-console eslint rule [Source: `architecture.md` → "MCP Server Logging Rule"]
- Architecture: initialization commands [Source: `architecture.md` → "Selected Approach: pnpm Workspaces Monorepo"]
- Epics: Story 1.1 acceptance criteria [Source: `_bmad-output/planning-artifacts/epics.md` → "Story 1.1"]
- Epics: AppError interface [Source: `epics.md` → "Story 1.4" acceptance criteria]

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-6

### Debug Log References

- shadcn/ui init attempted `npm install` (picked up npm from create-next-app's lock file); resolved by removing `package-lock.json` and running `pnpm add` manually for shadcn deps
- `@types/node` was missing from mcp-server devDeps — added to fix `process`/`console` TypeScript errors
- pnpm `approve-builds` required for esbuild/sharp/unrs-resolver — resolved via `pnpm.onlyBuiltDependencies` in root `package.json`; `.npmrc` `approve-builds=true` removed (was overly broad, bypassed onlyBuiltDependencies whitelist)
- `apps/web` package name updated from `"web"` to `"@on-record/web"` for workspace naming consistency
- Code review (claude-sonnet-4-6): `tw-animate-css` was not declared as an explicit dependency despite being imported in globals.css — added via pnpm; `@import "shadcn/tailwind.css"` removed from globals.css (`shadcn` is a CLI-only package with no CSS exports; all CSS variables were already written inline by shadcn init); `jsx: "react-jsx"` override removed from web tsconfig (contradicted shared nextjs.json `jsx: "preserve"` setting); `exports` field added to packages/types/package.json for proper NodeNext resolution; mcp-server placeholder log message corrected from "listening" to "starting"

### Completion Notes List

- All 7 acceptance criteria satisfied and verified
- Next.js 16.1.6 with Turbopack scaffolded; Tailwind v4 included by default
- shadcn/ui initialized — CSS variables written to globals.css; components.json written
- Both apps typecheck clean (`tsc --noEmit` exits 0)
- Both dev servers start without errors (web: localhost:3000; mcp: localhost:3001)
- packages/types exports 6 interfaces + BillDetail placeholder (for Story 2.2)
- No barrel files anywhere in project
- strict mode + noUncheckedIndexedAccess + exactOptionalPropertyTypes enabled across all tsconfigs

### File List

- `package.json` (created)
- `pnpm-workspace.yaml` (created)
- `.gitignore` (created)
- `.npmrc` (created — approve-builds removed in code review; onlyBuiltDependencies in package.json is the correct mechanism)
- `pnpm-lock.yaml` (generated by pnpm install)
- `packages/typescript-config/package.json` (created)
- `packages/typescript-config/base.json` (created)
- `packages/typescript-config/nextjs.json` (created)
- `packages/typescript-config/node.json` (created)
- `packages/types/package.json` (created)
- `packages/types/index.ts` (created)
- `apps/web/` (scaffolded via create-next-app@latest)
- `apps/web/package.json` (modified — name, workspace deps, shadcn deps, tw-animate-css added)
- `apps/web/tsconfig.json` (modified — extends @on-record/typescript-config/nextjs.json; jsx/paths overrides removed)
- `apps/web/.env.example` (created)
- `apps/web/.gitignore` (created by create-next-app — web-app-specific ignores: .vercel, next-env.d.ts, *.tsbuildinfo)
- `apps/web/eslint.config.mjs` (created by create-next-app — ESLint v9 flat config format)
- `apps/web/postcss.config.mjs` (created by create-next-app — PostCSS config for Tailwind v4)
- `apps/web/README.md` (created by create-next-app — placeholder, will be replaced in Story 1.5)
- `apps/web/next-env.d.ts` (created by Next.js — auto-managed, do not edit)
- `apps/web/components.json` (created by shadcn/ui init)
- `apps/web/src/app/globals.css` (modified by shadcn/ui init — CSS variables added; bogus @import "shadcn/tailwind.css" removed in code review)
- `apps/mcp-server/package.json` (created)
- `apps/mcp-server/tsconfig.json` (created)
- `apps/mcp-server/.eslintrc.json` (created)
- `apps/mcp-server/.env.example` (created)
- `apps/mcp-server/src/index.ts` (created)
